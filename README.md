# Housman Learning Core (HL Core) Plugin

**Version:** 1.0.0
**Requires:** WordPress 6.0+, PHP 7.4+, JetFormBuilder (for observation forms only)
**Status:** v1 complete — Phases 1-31 done (28 shortcode pages incl. dashboard + documentation, 15 admin pages, 35 DB tables, tabbed track editor, paginated TSA, child assessment instruments with admin-customizable instructions + behavior key + display styles, teacher assessment visual editor + modern frontend design, separate PRE/POST teacher instruments, role-aware dashboard shortcode, instrument nuke protection with `--include-instruments` opt-in, in-site documentation system with CPT, glossary, search, cross-linking, K-2nd grade age group, instrument preview, JFB cleanup)

## Overview

HL Core is the system-of-record plugin for Housman Learning Academy Track and Cohort management. It manages organizations, track enrollment, learning pathways, assessments, observations, coaching sessions, imports, and reporting.

## What's Implemented

### Database Schema (35 custom tables)
- **Org & Track/Cohort:** `hl_orgunit`, `hl_track` (with `is_control_group` flag), `hl_track_school`, `hl_cohort` (container)
- **Participation:** `hl_enrollment`, `hl_team`, `hl_team_membership`
- **Classrooms:** `hl_classroom`, `hl_teaching_assignment`, `hl_child`, `hl_child_classroom_current`, `hl_child_classroom_history`
- **Learning Config:** `hl_pathway`, `hl_pathway_assignment`, `hl_activity`, `hl_activity_prereq_group`, `hl_activity_prereq_item`, `hl_activity_drip_rule`, `hl_activity_override`
- **State/Rollups:** `hl_activity_state`, `hl_completion_rollup`
- **Instruments:** `hl_instrument` (child assessment instruments with `instructions` + `behavior_key` + `styles_json` columns for admin-customizable content and display styles), `hl_teacher_assessment_instrument` (custom teacher self-assessment instruments with structured sections JSON + `instructions` + `styles_json` columns for per-instrument rich text instructions and admin-customizable display styles)
- **Assessments:** `hl_teacher_assessment_instance` (completion tracking + responses_json for custom instruments, jfb_form_id/jfb_record_id for JFB fallback), `hl_teacher_assessment_response` (DEPRECATED), `hl_child_assessment_instance`, `hl_child_assessment_childrow`
- **Observations:** `hl_observation` (+ jfb_form_id/jfb_record_id), `hl_observation_response` (DEPRECATED — retained for dbDelta safety; JFB Form Records handles response storage), `hl_observation_attachment`
- **Coaching:** `hl_coaching_session`, `hl_coaching_session_observation`, `hl_coaching_attachment`
- **System:** `hl_import_run`, `hl_audit_log`

### Domain Models & Repositories
All 9 core entities have domain model classes with proper properties and repository classes with full CRUD:
- OrgUnit, Cohort, Enrollment, Team, Classroom, Child, Pathway, Activity, Teacher_Assessment_Instrument

### Services (Business Logic)
- **CohortService** - Cohort CRUD with validation
- **EnrollmentService** - Enrollment management with uniqueness checks
- **TeamService** - Team + membership management with constraints: hard enforcement of 1 team per enrollment per cohort, soft max-2-mentors-per-team (override-capable)
- **ClassroomService** - Full classroom CRUD, teaching assignment CRUD (create/update/delete with audit logging + auto-trigger child assessment instance generation), child classroom assignment/reassignment with history tracking
- **PathwayService** - Pathway + Activity CRUD
- **RulesEngineService** - Full prerequisite + drip rule evaluation engine
  - ALL_OF, ANY_OF, and N_OF_M prerequisite group types
  - Fixed date and completion-delay drip rules
  - "Most restrictive wins" logic
  - Override handling (exempt, manual_unlock, grace_unlock)
  - Prerequisite cycle detection (DFS-based) with admin validation on save
- **AssessmentService** - Teacher/Child assessment queries + completion checks + child assessment activity_state updates + rollup triggering on submission + instance auto-generation for cohort teaching assignments
- **ObservationService** - Full observation CRUD: create draft observations, query by cohort/mentor/user with joined data, get observable teachers from team membership, teacher classroom lookup, observation activity/form lookup for JFB integration
- **CoachingService** - Full coaching session CRUD (create/update/delete) + attendance marking with activity_state updates + rollup triggering + observation linking/unlinking + attachment management (WP Media)
- **AuditService** - Full audit logging to `hl_audit_log` table
- **ImportService** - CSV import with preview/commit workflow supporting four import types: participants (identity matching, WP user creation, enrollment), children (fingerprint-based matching, classroom assignment), classrooms (duplicate detection by school+name), teaching assignments (email-to-enrollment lookup). Header synonym mapping, error reporting with remediation suggestions
- **PathwayAssignmentService** - Explicit pathway-to-enrollment assignments: assign/unassign/bulk_assign/bulk_unassign, get_pathways_for_enrollment (explicit first, role-based fallback), get_enrollments_for_pathway, get_unassigned_enrollments, sync_role_defaults (auto-assign by target_roles matching), enrollment_has_pathway check, legacy assigned_pathway_id sync
- **ReportingService** - Completion rollup engine (weighted average, upsert to hl_completion_rollup, live LD fallback), cohort batch recompute, on-the-fly computation, activity-level detail query, cohort summary, scope-filtered participant report (cohort/school/district/team/role filters), cohort activity detail (batch per-enrollment per-activity), school summary (grouped by school), team summary (grouped by team), group summary (cross-cohort aggregation), group aggregate metrics, **program vs control group comparison** (per-section/per-item mean aggregation with Cohen's d effect size), CSV exports (participant completion with per-activity columns, school summary, team summary, group summary, comparison CSV)

### Admin Pages (WP Admin UI)
Full CRUD admin pages with WordPress-styled tables and forms:
- **Cohorts** - List, create, edit/delete cohorts. Group column in list. Control group badge (purple) in list and editor header. **Tabbed Editor:** 7-tab interface for existing cohorts (Details with group dropdown + control group checkbox, Schools, Pathways, Teams, Enrollments with pathway column, Coaching, Classrooms). Control group cohorts auto-hide Coaching and Teams tabs. **Inline sub-entity CRUD:** Pathways/Teams/Enrollments tabs now support `&sub=new|edit|view|activity` for full inline CRUD — forms render inside the cohort editor with breadcrumbs, cohort-locked dropdown, and save/delete redirects back to the correct tab. Standalone pages still work independently. Schools tab with link/unlink. Enrollments tab with completion bars + pagination + pathway names + inline edit/enroll. Coaching tab with assignments + recent sessions. Classrooms tab scoped to linked schools.
- **Cohort Groups** - Full CRUD for program-level cohort grouping. Create/edit/delete groups with name, code, status, description. Linked cohorts display on edit page. Cohorts assigned via group dropdown on cohort Details form.
- **Org Units** - Hierarchical district-centric view: districts as collapsible sections with nested school tables showing leader names, classroom/cohort counts. "Add District" and "Add School" header buttons. Edit form enhancements: dynamic titles, contextual breadcrumbs, district edit shows child schools table with "Add School" button, school edit shows linked cohorts/classrooms/staff tables. Pre-fill support for type and parent from URL params.
- **Enrollments** - Enroll users in cohorts with role assignment, cohort filter
- **Pathways & Activities** - Configure pathways per cohort, add activities with type-specific dropdowns (JFB form selector, HL instrument selector, LearnDash course selector), auto-built external_ref JSON, prerequisite group editor (all_of/any_of/n_of_m with cycle detection), prereq summary column in activity list, drip rule UI (fixed release date + delay-after-activity with base_activity selector and delay_days). **Clone/Template:** Clone pathway to any cohort (copies activities, prereqs, drip rules with ID remapping). Save as Template / Templates tab. Start from Template on new pathway form. **Pathway Assignments:** Assigned Enrollments section on pathway detail with count badge, sync role defaults button, bulk assign multi-select, quick assign dropdown, assignment table with type badges (Explicit/Role Default) and remove button.
- **Teams** - Create teams within cohorts/schools, view team members
- **Classrooms** - Full CRUD with detail view: teaching assignments (cohort-scoped add/remove) + children roster (assign/reassign/remove with history)
- **Imports** - AJAX-based 3-step wizard (Upload > Preview & Select > Results) for CSV import with import type selector (participants, children, classrooms, teaching assignments), dynamic column rendering per type, row-level status badges, bulk actions, commit, error report download, column hints per type, and import history table
- **Audit Log** - Searchable audit log viewer with cohort and action type filters, pagination

- **Instruments** - Full CRUD for child assessment instruments: question editor (add/edit/remove with type, prompt, allowed_values, required flag), version management with edit warnings when instances exist. Types: children_infant, children_toddler, children_preschool, children_mixed (varchar(50) column supports future types). **Child instrument admin** includes wp_editor for custom instructions + fixed 5-row behavior key table (label, frequency, description) — blank fields fall back to hard-coded defaults on the frontend. **Teacher Assessment Visual Editor:** structured section builder with collapsible accordion panels, scale label panels (likert ordered labels or numeric low/high anchors), per-item rich text (B/I/U via contenteditable), wp_editor for instructions, dynamic add/remove for sections/items/scales/labels — replaces raw JSON textareas. **Display Styles panel** (both child and teacher forms): collapsible admin section with per-element font-size dropdown (12-24px) and color picker for instructions, section titles, section descriptions, items, scale labels, and behavior key. Stored as `styles_json` on instrument rows. Renderers emit CSS overrides from `styles_json` values; empty/missing keys fall back to built-in defaults.
- **Coaching Sessions** - Full CRUD with cohort filter, mentor/coach selectors, session title, meeting URL, date/time, session status dropdown (scheduled/attended/missed/cancelled with terminal-state lock), rich-text notes (wp_editor), observation linking from submitted observations, WP Media attachments
- **Coach Assignments** - Full CRUD for coach-to-scope assignments (school/team/enrollment) with cohort filter, scope name resolution, active/ended status badges, effective date management

- **Assessments** - Tabbed staff assessment viewer/exporter: teacher self-assessments (list/detail/CSV), child assessments (list/detail/instance generation from teaching assignments/CSV), summary metric cards. Phase section headers (PRE/POST grouping with counts), clickable teacher names (link to WP user edit), dev-only switch-to-user feature (gated by `HL_DEV_TOOLS` constant). **Dual CSV exports per type:** "Export Completion CSV" (metadata only) and "Export Responses CSV" (full scored response data). Teacher responses export reads `responses_json` from instances with instrument-derived column headers (section: item_key). Child responses export outputs one row per child with answer columns, excluding skipped children.
- **Reports** - Full reporting dashboard: scope-based filtering (cohort/school/district/team/role + cohort group), summary cards, school/team summary tables, participant completion table with progress bars, enrollment detail drill-down with activity-level status, **program vs control group comparison section** (per-section/per-item tables with color-coded change values when cohort group filter contains both program and control cohorts), CSV exports (completion, school summary, team summary, teacher assessments, child assessments, comparison CSV with Cohen's d), rollup recompute action

**Admin fix:** All admin pages use `admin_init` dispatcher for POST saves and GET deletes (redirect-before-output pattern), preventing blank pages after form submissions.

### Front-End Pages (Shortcodes)
- **My Progress** `[hl_my_progress]` - Participant's own cohort progress with pathway/activity completion, progress rings, inline JFB form embedding for teacher self-assessments (via `?hl_open_activity=ID`), contextual action links for observations/child assessment/coaching activities
- **Team Progress** `[hl_team_progress]` - Mentor's team view with member cards, expandable activity details
- **Cohort Dashboard** `[hl_cohort_dashboard]` - Leader/staff cohort overview with school filter, participant completion table
- **Child Assessment** `[hl_child_assessment]` - Teacher's child assessment workflow: instance list, branded assessment form (Housman logo, teacher/school/classroom info, instructions, age-band-specific Key & Example Behavior table, transposed Likert matrix with Never→Almost Always labels mapped from 0-4 numeric values), draft save, final submit, branded read-only submitted summary with answer dots
- **Observations** `[hl_observations]` - Mentor observation workflow: observation list, new observation (select teacher from team + optional classroom), JFB form rendering with pre-populated hidden fields, submitted summary view
- **My Programs** `[hl_my_programs]` - Participant's program cards grid: featured image, program name, cohort name, completion %, status badge (Not Started/In Progress/Completed), "Continue"/"Start" button linking to Program Page. Uses PathwayAssignmentService for explicit/role-based pathway resolution with legacy fallback. Auto-discovers `[hl_program_page]` page URL. Empty state for no enrollments. My Coach widget: avatar, name, email, "Schedule a Session" button via CoachAssignmentService resolution.
- **Program Page** `[hl_program_page]` - Single program detail page (via `?id=X&enrollment=Y`): hero image, pathway name, description, cohort name, progress ring, details panel (avg time, expiration, status), objectives, syllabus link, activity cards with per-activity status/progress/actions. Activity actions route to Activity Page, LD course permalink, or child assessment page. Breadcrumb back to My Programs.
- **Activity Page** `[hl_activity_page]` - Single activity page (via `?id=X&enrollment=Y`): renders JFB form for self-assessments/observations (with hidden fields), links to child assessment page, redirects to LD course, shows managed-by-coach notice for coaching. Locked/completed guards with reason display. Breadcrumb back to Program Page.
- **My Cohort** `[hl_my_cohort]` - Auto-scoped cohort workspace for School Leaders and District Leaders. Cohort switcher for multi-enrollment users. Scope auto-detection (school_leader → school, district_leader → district, staff → all). Four tabs: Teams (cards with mentor names, member count, avg completion, progress bar, "View Team" link), Staff (searchable table with name/email/team/role/completion), Reports (filterable completion table with institution/team/name filters, expandable per-activity detail rows, CSV download), Classrooms (table with school/age band/child count/teacher names, links to classroom page).
- **Team Page** `[hl_team_page]` - Team detail page (via `?id=X`): dark gradient header with team name, school, cohort, member count, mentor names, avg completion metric. Two tabs: Team Members (searchable table with name, email, role badge, completion progress bar), Report (completion report table with per-activity detail expansion and CSV export). Access control: staff, team members, school/district leaders with matching scope. Breadcrumb back to My Cohort.
- **Classroom Page** `[hl_classroom_page]` - Classroom detail page (via `?id=X`): dark gradient header with classroom name, school name, age band, teacher names. Searchable children table with name, date of birth, computed age (years/months), gender (from metadata JSON). Access control: staff, assigned teachers, school/district leaders with matching scope. Breadcrumb back to My Cohort.
- **Districts Listing** `[hl_districts_listing]` - Staff CRM directory card grid of all school districts: district name, # schools, # active cohorts (via cohort_school join). Links to District Page. Staff-only access (manage_hl_core).
- **District Page** `[hl_district_page]` - District detail page (via `?id=X`): dark gradient header with district name and stat boxes (schools, participants). Sections: Active Cohorts (rows with name, status badge, dates, participant count, "Open Cohort" link to Cohort Workspace filtered by district), Schools (card grid with leader names, "View School" link), Overview stats. Access: staff + district leaders enrolled in that district. Breadcrumb to Districts Listing.
- **Schools Listing** `[hl_schools_listing]` - Staff CRM card grid of all schools: school name, parent district, leader names. Links to School Page. Staff-only access (manage_hl_core).
- **School Page** `[hl_school_page]` - School detail page (via `?id=X`): dark gradient header with school name, parent district link. Sections: Active Cohorts (rows with participant count at this school, "Open Cohort" link to Cohort Workspace filtered by school), Classrooms table (age band, children, teachers), Staff table (name, email, role, cohort). Access: staff + school leaders + district leaders of parent. Breadcrumb to parent district or Schools Listing.
- **Cohort Workspace** `[hl_cohort_workspace]` - Full cohort command center (via `?id=X&orgunit=Y`). My Cohort header with scope indicator and org unit filter dropdown for staff. Five tabs: Dashboard (avg completion %, total participants, completed/in-progress/not-started counts, teacher/mentor/school counts), Teams (card grid reusing team card pattern), Staff (searchable table), Reports (filterable completion table with per-activity detail expansion and CSV export), Classrooms (table). Control group cohorts auto-hide Teams tab. Scope from URL orgunit parameter or enrollment roles. Access: staff + enrolled leaders. Breadcrumb to source district/school page.
- **My Coaching** `[hl_my_coaching]` - Participant coaching page: coach info card (avatar, name, email) via CoachAssignmentService resolution, enrollment switcher, upcoming sessions with meeting link/reschedule/cancel, past sessions with status badges, schedule new session form with auto-suggested title from next coaching activity
- **Cohorts Listing** `[hl_cohorts_listing]` - Scope-filtered cohort card grid with search bar, cohort group filter dropdown, and status filter checkboxes (Active/Future default, Paused, Archived). Shows cohort name, code, status badge, start/end dates, participant count, school count. Links to Cohort Workspace. Scope: admin all, coach assigned cohorts, leaders enrolled cohorts.
- **Institutions Listing** `[hl_institutions_listing]` - Combined districts + schools view with All/Districts/Schools toggle, search bar. Districts show school count and active cohort count. Schools show parent district and leader names. Scope: admin all, leaders see own district/school scope.
- **Coaching Hub** `[hl_coaching_hub]` - Front-end coaching session table with search (participant/coach/title), status filter, cohort filter. Shows title, participant, coach, date/time, status badge, meeting link. Scope: admin all, coach assigned cohorts, enrolled users own sessions.
- **Classrooms Listing** `[hl_classrooms_listing]` - Searchable classroom table with school and age band filters. Shows classroom name, school, age band badge, child count, teacher names. Links to Classroom Page. Scope: admin all, leaders by school, teachers own assignments.
- **Learners** `[hl_learners]` - Participant directory with pagination (25/page), search by name/email, cohort/school/role filters. Shows name (BuddyBoss profile link), email, roles, school, cohort, completion progress bar. Scope: admin all, coach assigned, leaders by scope, mentors team only.
- **Pathways Listing** `[hl_pathways_listing]` - Staff-only pathway browser with search and cohort filter. Card grid: pathway name, cohort, activity count, target roles, featured image, avg completion time. Scope: admin/coach only.
- **Reports Hub** `[hl_reports_hub]` - Card grid of available report types: Completion Report (links to workspace/my-cohort reports tab), Coaching Report (links to coaching hub), Team Summary (links to workspace/my-cohort teams tab), Program Group Report (cross-cohort, coming soon), Assessment Report (coming soon). Role-based card visibility.
- **My Team** `[hl_my_team]` - Auto-detects mentor's team via team_membership. Single team: renders Team Page inline. Multiple teams: team selector card grid with name, school, member count, cohort. No teams: friendly message.
- **Dashboard** `[hl_dashboard]` - Role-aware LMS home page replacing Elementor dashboard. Detects user roles from `HL_Scope_Service` + `hl_enrollment.roles` JSON + `hl_track.is_control_group`. Welcome banner with time-based greeting and avatar. Participant section: My Programs + My Classrooms for all enrolled; My Coaching for program tracks (hidden for control-group-only users); My Team + Coaching Hub for mentors; My Track for leaders. Staff/admin Administration section: Tracks, Institutions, Learners, Pathways, Coaching Hub, Reports. Cards silently hide if target page doesn't exist.
- **Documentation** `[hl_docs]` + `[hl_doc_link]` - In-site documentation browser powered by `hl_doc` CPT and `hl_doc_category` taxonomy. Landing page with category card grid + search bar. Article detail view with left sidebar navigation, auto-generated TOC from h2/h3 headings, scroll spy, prev/next navigation. Glossary page with alphabetized letter nav and definition list. `[hl_doc_link slug="..." text="..."]` inline cross-reference shortcode for use inside article content. Sidebar search filtering, mobile-responsive with slide-out sidebar toggle. Admin creates/edits articles via WP Admin > HL Core > Doc Articles. BuddyBoss sidebar link visible to all enrolled users + staff. `wp hl-core seed-docs` seeds ~22 articles + ~15 glossary terms with real useful content and cross-links.

### Scope Service
- **HL_Scope_Service** — Shared static helper for role-based scope filtering across all listing pages. Detects user role (admin/coach/leader/mentor/teacher), computes visible cohort_ids, school_ids, district_ids, team_ids, enrollment_ids. Admin sees all (empty arrays = no restriction). Coach filtered by hl_coach_assignment + own enrollments. District leader expands to all schools in district. Static cache per user_id per request. Convenience helpers: can_view_cohort(), can_view_school(), has_role(), filter_by_ids().

### Security
- Custom `manage_hl_core` capability
- Coach WP role created on activation
- `HL_Security::assert_can()` for server-side checks
- Assessment response privacy (staff-only access)
- Import wizard: per-action nonces, capability checks, run ownership verification, file validation (extension + MIME + size)

### WP-CLI Commands
- **`wp hl-core seed-demo`** — Creates a full realistic demo dataset: 1 district, 2 centers, 1 active cohort, 4 classrooms, 3 instruments, 16 users (10 teachers, 2 mentors, 2 center leaders, 1 district leader, 1 coach), 15 enrollments, 2 teams with memberships, 10 teaching assignments, ~26 children, 2 pathways (teacher: 5 activities, mentor: 2 activities), prerequisite and drip rules, partial activity completion states, computed rollups, 3 coach assignments (2 center-level + 1 team-level), and 6 coaching sessions (attended, scheduled, missed, rescheduled, cancelled)
- **`wp hl-core seed-demo --clean`** — Removes all demo data (users, cohort, org units, instruments, children, coach assignments, coaching sessions, and all dependent records) identified by cohort code `DEMO-2026` and `demo-*@example.com` user emails
- **`wp hl-core seed-palm-beach`** — Seeds realistic demo data from the ELC Palm Beach County program: 1 district, 12 centers (3 Head Start + 1 learning center + 8 FCCHs), 1 active cohort, 29 classrooms, 3 instruments, 57 users (47 real teachers with actual names/emails, 4 center leaders, 4 mentors, 1 district leader, 1 coach), 56 enrollments (8 FCCH teachers dual-role as center leaders), 4 teams (WPB Alpha/Beta, Jupiter, South Bay), 47 teaching assignments, 286 real children (with DOBs, gender, ethnicity metadata), 2 pathways (teacher: 5 activities, mentor: 2 activities), prerequisite and drip rules, partial activity states, computed rollups, 4 coach assignments (3 center-level + 1 team-level), 5 coaching sessions, **1 cohort group (B2E Program Evaluation)**, **1 Lutheran Services Florida control cohort (LSF-CTRL-2026)** with 6 control participants and submitted PRE assessments for comparison reporting
- **`wp hl-core seed-palm-beach --clean`** — Removes all Palm Beach data (users, cohort, org units, instruments, children, classrooms, coach assignments, coaching sessions, control cohort, cohort group, and all dependent records) identified by cohort code `ELC-PB-2026`/`LSF-CTRL-2026` and `_hl_palm_beach_seed` user meta
- **`wp hl-core seed-lutheran`** — Seeds Lutheran Services Florida control group data: 1 district, 11 centers, 1 control cohort (LUTHERAN_CONTROL_2026) in B2E Evaluation cohort group, 29 classrooms with age band normalization, 47 WP users (teachers), 47 enrollments, 47 teaching assignments, 286 children with DOBs/gender/ethnicity metadata, assessment-only pathway (4 activities: TSA Pre, CA Pre, TSA Post, CA Post), B2E teacher instrument, 4 child assessment instruments (infant, toddler, preschool, mixed), 94 teacher + 94 child assessment instances with proper instrument/phase/activity linkage, 188 activity states, POST activities time-gated via drip rules (fixed_date 2026-05-05)
- **`wp hl-core seed-lutheran --clean`** — Removes all Lutheran data in reverse dependency order (activity states, assessment instances, children, teaching assignments, classrooms, enrollments, users, pathways, instruments, cohort, org units) identified by cohort code `LUTHERAN_CONTROL_2026` and `_hl_lutheran_seed` user meta
- **`wp hl-core nuke --confirm="DELETE ALL DATA" [--include-instruments]`** — **DESTRUCTIVE: Deletes ALL HL Core data.** Dynamically discovers all `hl_*` tables via `SHOW TABLES LIKE`, shows per-table row counts before truncating, removes seeded WP users (but protects user ID 1 and the current CLI user), resets auto-increment, clears HL Core transients (`_transient_hl_%`). Safety gate: only runs on sites with URL containing `staging.academy.housmanlearning.com` or `.local`. **By default, skips `hl_instrument` and `hl_teacher_assessment_instrument` tables** to preserve admin customizations (instructions, questions, styles). Pass `--include-instruments` to truncate instrument tables as well.
- **`wp hl-core seed-docs [--clean]`** — Seeds ~22 documentation articles across 7 categories + ~15 glossary terms for the in-site documentation system. Uses `hl_doc` CPT and `hl_doc_category` taxonomy. Skip-if-exists by slug. `--clean` deletes all existing doc articles before seeding.
- **`wp hl-core create-pages`** — Creates all 28 WordPress pages for HL Core shortcodes (personal, directory, hub, detail, assessment, dashboard, and documentation pages). Skips pages that already exist. `--force` to recreate. `--status=draft` for staging.

### REST API
- `GET /wp-json/hl-core/v1/cohorts`
- `GET /wp-json/hl-core/v1/cohorts/{id}`
- `GET /wp-json/hl-core/v1/enrollments?cohort_id=X`
- `GET /wp-json/hl-core/v1/orgunits?type=center`
- `GET /wp-json/hl-core/v1/pathways?cohort_id=X`
- `GET /wp-json/hl-core/v1/teams?cohort_id=X`

### LearnDash Integration
- Course progress reading via `learndash_course_progress()`
- Course completion event hook (`learndash_course_completed`) — fully wired: finds enrollments, matches activities by course_id, marks complete, triggers rollups, audit logs
- Batch progress reading for reporting

### BuddyBoss Integration
- **HL_BuddyBoss_Integration** service (`includes/integrations/class-hl-buddyboss-integration.php`)
- Multi-hook injection strategy for reliable menu rendering:
  1. **Profile Dropdown** — `buddyboss_theme_after_bb_profile_menu` (last hook in header-profile-menu.php)
  2. **BuddyPanel Left Sidebar** — `wp_nav_menu_items` filter on `buddypanel-loggedin` location, appends section divider + items using native BB CSS classes
  3. **JS Fallback** — `wp_footer` injects into BuddyPanel DOM and/or profile dropdown if PHP hooks did not fire (covers empty BuddyPanel menu or custom profile dropdown override)
- 11 menu items with role-based visibility (matches doc 10 section 16):
  - **Personal (require active enrollment):** My Programs, My Coaching (any enrollment), My Team (mentor only), My Cohort (leader or mentor)
  - **Directories:** Cohorts, Institutions (staff or leader), Classrooms (staff, leader, or teacher), Learners (staff, leader, or mentor)
  - **Staff tools:** Pathways (staff only), Coaching Hub (staff or mentor), Reports (staff or leader)
- Staff WITHOUT enrollment see only directory/management pages; staff WITH enrollment see both personal and management pages
- Multi-role users see union of all role menus
- Active page highlighting via `current` / `current-menu-item` CSS class
- Role detection from `hl_enrollment.roles` JSON (not WP roles) with static caching
- Menu items built once per request via `get_menu_items_for_current_user()` (static cache shared across all three hooks)
- Shortcode-based page URL discovery with static caching
- Graceful no-op when BuddyBoss is not active

### JetFormBuilder Integration
- **HL_JFB_Integration** service (`includes/integrations/class-hl-jfb-integration.php`)
- Hook listener for `hl_core_form_submitted` custom action — processes teacher self-assessment and observation submissions
- Automatic activity_state completion on JFB form submit
- Front-end form rendering helper with hidden field pre-population
- Admin notice when JetFormBuilder is inactive
- Available forms query for admin dropdowns
- JFB-powered activity types disabled in admin when JFB not active

---

## Build Queue (Ordered — work top to bottom)

This is the prioritized task list. Each session, pick up from the first unchecked `[ ]` item.

### Phase 1: JetFormBuilder Integration Foundation
_Read docs: 06 (section 2), 04 (section 3.2.2, 3.2.5), 09 (section 3.3)_

- [x] **1.1 DB Schema Cleanup** — In class-hl-installer.php: deprecated `hl_teacher_assessment_response` and `hl_observation_response` table definitions (retained for dbDelta safety). Added `jfb_form_id` and `jfb_record_id` columns to `hl_teacher_assessment_instance` and `hl_observation`. Cleaned `hl_instrument` enum to only children_infant, children_toddler, children_preschool.
- [x] **1.2 JFB Integration Service** — Created `includes/integrations/class-hl-jfb-integration.php`. Hook listener for `jet-form-builder/custom-action/hl_core_form_submitted` that processes teacher_self_assessment and observation submissions: updates instance records, marks activity_state complete, fires rollup recomputation action, logs audit. Includes front-end form rendering helper, available forms query for admin, and admin notice when JFB is inactive.
- [x] **1.3 Activity Admin Enhancement** — Updated Pathways & Activities admin: activity_type dropdown now uses correct DB enum values (learndash_course, teacher_self_assessment, child_assessment, coaching_session_attendance, observation). Conditional dropdowns: JFB form selector + phase for self-assessments, JFB form + required count for observations, HL instrument dropdown for child assessments, LearnDash course selector for courses. Builds external_ref JSON from selections. Activity list shows linked resource names. JFB types disabled in dropdown when JFB not active.

### Phase 2: LearnDash Completion Wiring
_Read docs: 04 (section 3.2.1), 09 (section 8)_

- [x] **2.1 LearnDash Hook Body** — Wired `learndash_course_completed` hook: finds all active enrollments for the user, matches learndash_course activities by course_id in external_ref, upserts hl_activity_state to 100% complete, triggers rollup recomputation for each affected enrollment, audit logs each completion.
- [x] **2.2 Completion Rollup Engine** — Implemented `HL_Reporting_Service::compute_rollups($enrollment_id)` as singleton with `hl_core_recompute_rollups` action listener. Calculates pathway_completion_percent as weighted average of all activity states. Falls back to live LearnDash progress for courses without cached state. Upserts hl_completion_rollup. Added `recompute_cohort_rollups()` for batch recomputation. Wired into: JFB hook listener, LearnDash hook, coaching attendance marking, and child assessment submission. Also enhanced `get_enrollment_completion()` to compute on-the-fly when no cached rollup exists. Updated `HL_Coaching_Service::mark_attendance()` to update coaching_session_attendance activity_state and trigger rollups. Updated `HL_Assessment_Service` to update child_assessment activity_state and trigger rollups on submission.

### Phase 3: Child Assessment (Custom Form)
_Read docs: 06 (sections 4.2–4.8), 04 (section 3.2.3)_

- [x] **3.1 Instruments Admin Page** — Built full CRUD admin page (`class-hl-admin-instruments.php`): list/create/edit instruments with question editor (JS add/remove rows, question_id, type, prompt_text, allowed_values, required flag). Version management with warning when editing instruments that have existing assessment instances. Only instrument_types: children_infant, children_toddler, children_preschool. Registered in admin menu.
- [x] **3.2 Instance Auto-Generation** — `AssessmentService::generate_child_assessment_instances($cohort_id)` already existed. Wired automatic triggering: ClassroomService `create_teaching_assignment()` and `delete_teaching_assignment()` now fire `hl_core_teaching_assignment_changed` action, which is listened to in hl-core.php init and calls `generate_child_assessment_instances()`. Instances are created per (cohort, enrollment, classroom) with matching instrument auto-selection by age band.
- [x] **3.3 HL_Instrument_Renderer** — Created `includes/frontend/class-hl-instrument-renderer.php`: renders per-child matrix form from instrument questions JSON + classroom roster. Supports all 5 question types (likert, text, number, single_select, multi_select). Save Draft and Submit buttons with confirmation. Sticky first column, responsive horizontal scroll.
- [x] **3.4 Child Assessment Front-End Page** — Created `includes/frontend/class-hl-frontend-child-assessment.php` with `[hl_child_assessment]` shortcode. Instance list view for teachers, single instance form (via HL_Instrument_Renderer with inline fallback), POST handling for draft/submit, read-only submitted summary, security (ownership verification + nonce checks). Registered in shortcodes class.

### Phase 4: Observation & Coaching Workflows
_Read docs: 06 (sections 5, 6)_

- [x] **4.1 Observation Create/Submit Flow** — Expanded `HL_Observation_Service` with full CRUD: `create_observation()`, `get_observation()` with joins, `get_by_mentor_user()`, `get_observable_teachers()` from team membership, `get_teacher_classrooms()`, `get_observation_activity()`, `get_observation_form_id()`. Created `class-hl-frontend-observations.php` with `[hl_observations]` shortcode: list view (all mentor observations), new observation flow (select teacher from team + optional classroom), form view (renders JFB form via `HL_JFB_Integration::render_form()` with pre-populated hidden fields), submitted summary view. Security: mentor enrollment verification, ownership checks, nonce validation. Registered in shortcodes class.
- [x] **4.2 Coaching Session Admin CRUD** — Expanded `HL_Coaching_Service` with full CRUD: `create_session()`, `update_session()`, `delete_session()`, `get_session()` with joins, observation linking/unlinking (`link_observations()`, `unlink_observation()`, `get_linked_observations()`, `get_available_observations()`), attachment management (`add_attachment()`, `remove_attachment()`, `get_attachments()`). Created `class-hl-admin-coaching.php`: list view with cohort filter + attendance badges, create/edit form with cohort/mentor/coach selectors + datetime + attendance radio + wp_editor notes + observation linking section + WP Media attachment picker. Attendance changes trigger existing `mark_attendance()` for activity_state + rollup updates. Registered in admin menu.

### Phase 5: Reporting Dashboard
_Read docs: 08, 09 (section 8)_

- [x] **5.1 Reporting Admin Page** — Replaced stub `class-hl-admin-reporting.php` with full reporting dashboard. Filters bar (cohort required, district/center/team/role optional), summary metric cards (active enrollments, avg completion, centers, teams), center summary table (when no center filter), team summary table (when center selected), participant completion table with inline progress bars and "View Detail" drill-down. Enrollment detail view shows header info + activity-level completion table with status badges. CSV export handling at top of render_page (completion, center summary, team summary, teacher assessment, child assessment). Recompute rollups action with nonce protection. Assessment Exports section (staff only) for teacher self-assessment and child assessment response exports.
- [x] **5.2 CSV Export** — Added `export_completion_csv()` (participant completion with optional per-activity columns), `export_center_summary_csv()`, `export_team_summary_csv()` to HL_Reporting_Service. All use `php://temp` + `fputcsv()`. Participant CSV includes: Name, Email, Roles, Center, Team, Cohort Completion %, Pathway Completion %, plus one column per activity. Child assessment response export (staff only) deferred to Assessments admin page.
- [x] **5.3 Scope-Filtered Queries** — Added `get_participant_report($filters)` with cohort/center/district/team/role/status filters, `get_cohort_activity_detail($cohort_id, $enrollment_ids)` for batch per-enrollment per-activity data, `get_center_summary($cohort_id, $district_id)` grouped by center, `get_team_summary($cohort_id, $center_id)` grouped by team, `get_cohort_activities($cohort_id)` helper. Scope filtering uses team.center_id via team_membership for center resolution, orgunit.parent_orgunit_id for district hierarchy, JSON LIKE for role filtering.

### Phase 6: Constraints & Polish
_Read docs: 02 (teams), 09 (acceptance tests)_

- [x] **6.1 Team Membership Constraints** — Enforced 1-team-per-enrollment-per-cohort as hard constraint in `TeamService::add_member()`: queries existing team memberships for the enrollment's cohort before allowing insertion. Soft constraint: max 2 mentors per team returns WP_Error unless `$force_override = true`. Both constraints return descriptive WP_Error messages.
- [x] **6.2 JFB Dependency Check** — Already implemented in Phase 1.2: `HL_JFB_Integration::maybe_show_inactive_notice()` shows admin notice on HL Core pages when JFB is inactive. `render_form()` returns "form unavailable" fallback. `get_available_forms()` returns empty when JFB inactive. Activity admin disables JFB types in dropdown when JFB not active (Phase 1.3). Acceptance test 9.10.29 satisfied.
- [x] **6.3 Front-End Form Embedding** — Updated `[hl_my_progress]` shortcode: teacher_self_assessment activities show "Open Form" button; clicking it renders the JFB form inline via `?hl_open_activity=ID` with hidden fields (hl_enrollment_id, hl_activity_id, hl_cohort_id) pre-populated from enrollment context. Back-to-Progress navigation, availability validation (locked/completed guard), and proper escaping. Observation activities show "Go to Observations" link/notice, child_assessment shows "Go to Child Assessment" link/notice, coaching_session_attendance shows "Managed by your coach" notice. Added `hl_core_observations_page_url` and `hl_core_child_assessment_page_url` filters for configurable page URLs. Added CSS for buttons, inline form wrapper, and activity action notices.
- [x] **6.4 Additional Import Types** — Extended ImportService with three new import types beyond participants: Children (validate_children_rows + commit_children_import with fingerprint-based identity matching, classroom assignment), Classrooms (validate_classroom_rows + commit_classroom_import with duplicate detection by center+name), Teaching Assignments (validate_teaching_assignment_rows + commit_teaching_assignment_import with email-to-enrollment lookup, duplicate detection). Updated admin import wizard with type dropdown (participants/children/classrooms/teaching_assignments), dynamic column hints, and type-aware AJAX routing. Updated JS preview table to render type-specific columns dynamically. Added header synonyms for date_of_birth, child_identifier, classroom_name, age_band, is_lead_teacher. Added remediation suggestions for all new error types.

### Phase 7: Front-End — Participant Experience
_Read docs: 10 (sections 4.1–4.3, 13 Phase A)_

- [x] **7.1 Pathway Model Expansion** — Added 6 columns to `hl_pathway`: description (longtext), objectives (longtext), syllabus_url (varchar 500), featured_image_id (bigint), avg_completion_time (varchar 100), expiration_date (date). DB migration `migrate_pathway_add_fields()` with column-exists guards. Schema revision bumped to 2. Domain model updated with 6 new properties. Admin Pathways form updated with wp_editor for description/objectives, URL input for syllabus, WP Media uploader for featured image, text input for avg time, date input for expiration. Save + detail display updated.
- [x] **7.2 My Programs Page** — Created `class-hl-frontend-my-programs.php` with `[hl_my_programs]` shortcode. Grid of program cards for logged-in user: featured image (or placeholder), pathway name, cohort name, completion % (weighted average with LD fallback), status badge (Not Started/In Progress/Completed), Continue/Start button. Auto-discovers `[hl_program_page]` page URL. Friendly empty state. Registered in shortcodes class + hl-core.php.
- [x] **7.3 Program Page** — Created `class-hl-frontend-program-page.php` with `[hl_program_page]` shortcode (`?id=X&enrollment=Y`). Validates pathway/enrollment ownership. Hero image, name, description, progress ring. Details panel (avg time, expiration, status with expired/completed/paused detection). Objectives section, syllabus link. Activity cards with per-activity status, progress bars, type badges, lock reasons, action buttons (LD course link, Activity Page link, managed-by-coach notice). Breadcrumb to My Programs.
- [x] **7.4 Activity Page** — Created `class-hl-frontend-activity-page.php` with `[hl_activity_page]` shortcode (`?id=X&enrollment=Y`). Per-type rendering: JFB form embed for self-assessments/observations (with hidden fields), child assessment page link, LD course redirect, coaching notice. Locked view with descriptive reason. Completed view. Breadcrumb to Program Page. Registered in shortcodes class + hl-core.php.

### Phase 8: Front-End — Leader Experience
_Read docs: 10 (sections 5.1, 7.1–7.2, 13 Phase B)_

- [x] **8.1 My Cohort Page** — Created `class-hl-frontend-my-cohort.php` with `[hl_my_cohort]` shortcode. Auto-detects user scope (Center Leader → center, District Leader → district, staff → all). Cohort switcher for multi-enrollment users. Four tabs: Teams (card grid with mentor names, member count, avg completion %, progress bars, "View Team" link to team page), Staff (searchable table with name/email/team/role/completion), Reports (filterable completion table with institution/team/name client-side filters, expandable per-activity detail rows, CSV download via template_redirect handler with nonce + scope verification), Classrooms (table with center/age band/child count/teacher names, links to classroom page). Batch queries for age bands, child counts, and teacher names. CSS for tab show/hide, teams grid, search input, report filters, detail rows. JS for search, filter dropdowns, and detail toggle. Registered in shortcodes class + hl-core.php.
- [x] **8.2 Team Page** — Created `class-hl-frontend-team-page.php` with `[hl_team_page]` shortcode (`?id=X`). Dark gradient header with team name, center, cohort, member count, mentor names, avg completion stat. Two tabs: Team Members (searchable table with name/email/role badge/completion progress bar), Report (filterable completion table with per-activity detail expand and CSV export via template_redirect handler). Access control: staff, team members, center/district leaders whose scope includes the team's center. Breadcrumb back to My Cohort (teams tab).
- [x] **8.3 Classroom Page** — Created `class-hl-frontend-classroom-page.php` with `[hl_classroom_page]` shortcode (`?id=X`). Dark gradient header with classroom name, center, age band, teacher names. Searchable children table: name, DOB, age (computed from DOB with yr/mo display), gender (from metadata JSON). Access control: staff, assigned teachers, center/district leaders whose scope includes the classroom's center. Breadcrumb back to My Cohort (classrooms tab).

### Phase 9: Front-End — Staff/Admin CRM Directory
_Read docs: 10 (sections 6.1–6.5, 13 Phase C)_

- [x] **9.1 Districts Listing** — `[hl_districts_listing]` shortcode. Card grid: district name, # centers (via orgunit parent), # active cohorts (via cohort_center join). Click → District Page. Staff-only (manage_hl_core).
- [x] **9.2 District Page** — `[hl_district_page]` shortcode with `?id=X`. Dark gradient header with name + stat boxes. Sections: Active Cohorts (cohort rows with "Open Cohort" → Cohort Workspace filtered by district), Centers (card grid with leader names → Center Page), Overview stats. Access: staff + district leaders.
- [x] **9.3 Centers Listing** — `[hl_centers_listing]` shortcode. Card grid: center name, parent district, center leader names. Click → Center Page. Staff-only (manage_hl_core).
- [x] **9.4 Center Page** — `[hl_center_page]` shortcode with `?id=X`. Dark gradient header with center name, parent district link. Sections: Active Cohorts (with per-center participant count), Classrooms table (age band, children, teachers), Staff table (name, email, role, cohort). Access: staff + center leaders + district leaders of parent.
- [x] **9.5 Cohort Workspace** — `[hl_cohort_workspace]` shortcode with `?id=X&orgunit=Y`. Full command center. Tabs: Dashboard (avg completion %, participant counts by status, staff/center counts), Teams (card grid), Staff (searchable table), Reports (filterable table with per-activity detail expand + CSV export), Classrooms (table). Org unit filter dropdown for staff. Scope from URL or enrollment. CSV export handler.

### Phase 10: Coach Assignment + Coaching Enhancement
_Read docs: 10 (sections 13–15)_

- [x] **10.1 Coach Assignment Table** — Added `hl_coach_assignment` table (coach_user_id, scope_type enum center/team/enrollment, scope_id, cohort_id, effective_from, effective_to) to class-hl-installer.php with indexes (cohort_scope, coach_user_id, cohort_coach). Created `HL_Coach_Assignment_Service` with: `assign_coach()`, `get_coach_for_enrollment()` (most-specific-wins resolution: enrollment → team → center), `reassign_coach()` (closes old + creates new), `delete_assignment()`, `get_assignments_by_cohort()`, `get_all_assignments_by_cohort()`, `get_coach_roster()`, `get_sessions_for_enrollment()`. Audit logging on assign/reassign/delete. Schema revision bumped to 3.
- [x] **10.2 Coaching Session Schema Expansion** — Added session_title, meeting_url, session_status (enum: scheduled/attended/missed/cancelled/rescheduled), cancelled_at, rescheduled_from_session_id to hl_coaching_session. Migration maps attendance_status → session_status. Updated HL_Coaching_Service: transition_status() with terminal state validation, cancel_session(), reschedule_session() (marks old as rescheduled + creates linked new session), is_cancellation_allowed() (reads cohort.settings JSON), get_upcoming_sessions()/get_past_sessions(), get_sessions_for_participant(). Backward-compat mark_attendance() syncs both fields. Static render_status_badge() helper.
- [x] **10.3 Admin UI Updates** — Created `class-hl-admin-coach-assignments.php`: full CRUD list/create/delete page with cohort filter, scope name resolution (center/team/enrollment), active/ended status badges, nonce-protected actions. Updated `class-hl-admin-coaching.php`: replaced attendance_status radio with session_status dropdown (scheduled/attended/missed/cancelled with terminal-state read-only lock), added session_title input and meeting_url input, updated list view with title column and status badges via `HL_Coaching_Service::render_status_badge()`. Registered Coach Assignments submenu page in admin.
- [x] **10.4 My Coaching Page** — Created `class-hl-frontend-my-coaching.php` with `[hl_my_coaching]` shortcode. Coach info card (avatar, name, email via CoachAssignmentService resolution), enrollment switcher for multi-enrollment users. Upcoming Sessions with meeting link, inline reschedule form (datetime-local), cancel button (respects cohort `coaching_allow_cancellation` setting). Past Sessions with status badges (no actions). Schedule New Session form with auto-suggested title from next incomplete coaching activity, datetime-local picker, optional meeting URL. POST handlers for schedule/reschedule/cancel via template_redirect with nonce + ownership verification. Registered shortcode + assets.
- [x] **10.5 My Coach Widget** — Added coach info card to My Programs page (`class-hl-frontend-my-programs.php`): coach avatar, name, email (mailto link), "Schedule a Session" button linking to `[hl_my_coaching]` page. Falls back to "No coach assigned" message when no assignment found. Uses CoachAssignmentService resolution across all user enrollments.
- [x] **10.6 Program Page Coaching Enhancement** — Updated coaching_session_attendance activity cards in `class-hl-frontend-program-page.php`: shows "Upcoming on [date]" badge with meeting link if session is scheduled, "Schedule Session" button linking to My Coaching page if no session, "Missed" badge with "Reschedule" link if session was missed. Falls back to "Managed by your coach" when no coaching page exists.

### Phase 11: Sidebar Navigation & Listing Pages
_Read docs: 10 (sections 16-17)_

- [x] **11.1 Cohorts Listing** — `[hl_cohorts_listing]` shortcode. Card grid with search bar and status filter checkboxes. Shows cohort name, code, status badge, start/end dates, participant count, center count. Links to Cohort Workspace. Scope via HL_Scope_Service.
- [x] **11.2 Institutions Listing** — `[hl_institutions_listing]` shortcode. Combined districts + centers view with All/Districts/Centers toggle, search. Districts show center/cohort counts. Centers show parent district, leader names. Scope via HL_Scope_Service.
- [x] **11.3 Coaching Hub** — `[hl_coaching_hub]` shortcode. Session table with search, status filter, cohort filter. Shows title, participant, coach, date/time, status badge, meeting link. Scope via HL_Scope_Service.
- [x] **11.4 Classrooms Listing** — `[hl_classrooms_listing]` shortcode. Table with center and age band filters, teacher names, child counts. Links to Classroom Page. Scope via HL_Scope_Service.
- [x] **11.5 Learners** — `[hl_learners]` shortcode. Participant directory with pagination (25/page), search, cohort/center/role filters, completion progress bars, BB profile links. Scope via HL_Scope_Service.
- [x] **11.6 Pathways Listing** — `[hl_pathways_listing]` shortcode. Staff-only card grid with search and cohort filter. Shows pathway name, cohort, activity count, target roles, featured image, avg time.
- [x] **11.7 Reports Hub** — `[hl_reports_hub]` shortcode. Card grid: Completion Report, Coaching Report, Team Summary, Assessment Report (coming soon). Role-based card visibility.
- [x] **11.8 My Team** — `[hl_my_team]` shortcode. Auto-detects mentor's team. Single team → inline Team Page render. Multiple → selector cards. None → friendly message.
- [x] **11.9 Sidebar Menu Rebuild** — Rewrote BuddyBoss sidebar with 11 role-based menu items covering all new listing pages. Union of roles for multi-role users. Active page highlighting. Multi-hook strategy: profile dropdown (`buddyboss_theme_after_bb_profile_menu`), BuddyPanel left sidebar (`wp_nav_menu_items` filter), and JS fallback (`wp_footer`) for reliable rendering regardless of BuddyPanel menu state.
- [x] **11.10 Create WordPress Pages** — `wp hl-core create-pages` CLI command creates all 24 shortcode pages. Skips existing. `--force` to recreate. `--status=draft` for staging.

### Phase 12: MS365 Calendar Integration (Future)
_Read docs: 10 (section 18 Phase E)_

- [ ] **12.1 Azure AD App + OAuth** — Register Azure AD app, implement OAuth consent flow for coach accounts, store refresh tokens securely.
- [ ] **12.2 Availability Endpoint** — Read coach MS365 calendar via Graph API `/me/calendarView`, expose available slots to booking UI.
- [ ] **12.3 Booking Flow** — Replace date-time picker with MS365 availability calendar. Create session in HL Core + MS365 calendar event for both parties.
- [ ] **12.4 Sync** — Reschedule/cancel propagate to MS365 calendar events.

### Phase 13: Front-End — BuddyBoss Profile Tab (Future)
_Read docs: 10 (section 2.4)_

- [~] **13.1 BB Profile Tab** — DONE: Sidebar navigation menu (`HL_BuddyBoss_Integration`) rebuilt in 11.9 with 11 role-based menu items covering all listing pages (Cohorts, Institutions, Classrooms, Learners, Pathways, Coaching Hub, Reports, My Team, My Programs, My Coaching, My Cohort). Multi-role union, active page highlighting. TODO: Custom profile tab for coaches/admins (enrollment info, pathway progress, team assignment, coaching sessions, action buttons).

### Phase 14: Admin UX Improvements

- [x] **14.1 Pathway Clone/Template Feature** — Added `is_template` column to `hl_pathway` (schema revision 4). `HL_Pathway_Service::clone_pathway()` deep-clones pathway + activities + prereq groups/items + drip rules with activity ID remapping (fixed_date drip rules nulled for admin to set new dates). Admin Pathways page: "Clone to Cohort" form on detail view, "Save as Template" / "Remove from Templates" toggle, "Templates" tab on list view with count badge, "Start from Template" dropdown on new pathway form.
- [x] **14.2 Tabbed Cohort Editor** — Redesigned cohort edit page into 7-tab interface: Details (existing form), Centers (link/unlink with district + leader names), Pathways (list + clone from template shortcut), Teams (mentor names + member counts), Enrollments (paginated with roles/team/center/completion bars), Coaching (coach assignments + recent sessions with status badges), Classrooms (scoped to linked centers with child/teacher counts). New cohorts redirect to edit page after first save. Cohort breadcrumbs on Teams, Enrollments, Pathways, Coaching Sessions, and Coach Assignments admin pages when cohort filter is active.

### Phase 15: Architecture — Explicit Pathway Assignments + Cohort Groups
_Read docs: 04 (section 2.2), 08_

- [x] **15.1 Pathway Assignment Table + Cohort Group Table** — Added `hl_pathway_assignment` table (enrollment_id, pathway_id, assigned_by_user_id, assignment_type enum explicit/role_default, unique key enrollment_pathway). Added `hl_cohort_group` table (group_id, group_uuid, group_name, group_code, description, status). Added `cohort_group_id` column to `hl_cohort` with migration. Schema revision bumped to 5.
- [x] **15.2 Pathway Assignment Service** — Created `HL_Pathway_Assignment_Service` with: assign/unassign/bulk_assign/bulk_unassign, get_pathways_for_enrollment (explicit first, role-based fallback via target_roles↔enrollment roles matching), get_enrollments_for_pathway, get_unassigned_enrollments, sync_role_defaults (auto-assign for all unassigned enrollments in a cohort), enrollment_has_pathway boolean check, sync_enrollment_assigned_pathway (legacy column sync). Audit logging on assign/unassign.
- [x] **15.3 Frontend Updates** — My Programs uses PathwayAssignmentService for multi-pathway support with role-based and legacy fallback. Program Page uses service-based access check with legacy fallback. Cohorts Listing adds cohort group filter dropdown with JS filtering.
- [x] **15.4 Admin Pathway Assignments UI** — Pathway detail page: Assigned Enrollments section with count badge, "Sync Role Defaults" button, bulk assign multi-select form, quick assign dropdown, assignment table with type badges (Explicit/Role Default) and remove button. Cohort Enrollments tab: pathway names column via batch query.
- [x] **15.5 Cohort Groups Admin Page** — Created `class-hl-admin-cohort-groups.php`: full CRUD list/create/edit/delete with name, code, status, description. Linked cohorts table on edit page. Group dropdown added to cohort Details form. Group column in cohort list. Registered in admin menu.
- [x] **15.6 Reporting: Group Summary** — Added `get_group_summary()`, `get_group_aggregate()`, `export_group_summary_csv()` to ReportingService. Added group_summary_csv export handler to admin reporting. Reports Hub adds Program Group Report card (staff + district leaders).

### Phase 16: Cohort Editor — Inline Sub-Entity CRUD

- [x] **16.1 Pathways Class — Cohort Context** — Made 8 methods public (get_pathway, get_activity, format_external_ref, format_prereq_summary, render_pathway_form, render_pathway_detail, render_activity_form, render_activity_form_js). Added `$context` parameter to render methods (suppresses header/back-link, locks cohort dropdown, adds `_hl_cohort_context` hidden field). Added `get_cohort_redirect()` helper. Updated all 10 action handlers (save_pathway, save_activity, handle_delete_pathway, handle_delete_activity, handle_clone_pathway, handle_toggle_template, handle_assign_pathway, handle_unassign_pathway, handle_bulk_assign_pathway, handle_sync_role_defaults) to check for `_hl_cohort_context` / `cohort_context` and redirect back to cohort editor tab.
- [x] **16.2 Teams Class — Cohort Context** — Made 3 methods public (get_team, render_form, render_team_detail). Added `$context` parameter to render methods. Updated save handler and delete handler with cohort context redirect support. Cohort dropdown locked when in cohort context.
- [x] **16.3 Enrollments Class — Cohort Context** — Made 2 methods public (get_enrollment, render_form). Added `$context` parameter to render_form. Updated save and delete handlers with cohort context redirect support. Cohort dropdown locked when in cohort context.
- [x] **16.4 Cohort Editor Tab Routing** — Rewritten Pathways/Teams/Enrollments tabs as routers with `$sub` parameter. Added breadcrumb helper (`render_breadcrumb()`), cohort context helper (`get_cohort_context()`), and 15+ new message keys. Pathways tab: sub=new|edit|view|activity with pathway/activity validation. Teams tab: sub=new|edit|view with team validation. Enrollments tab: sub=new|edit with enrollment validation. List sub-views updated with cohort-context links (view/edit/delete). Added "Full Page View" link on each tab for cross-cohort browsing.

### Phase 17: Admin UX — Hierarchy & Navigation
- [x] **17.1 Org Units Hierarchical View** — Rewrote `class-hl-admin-orgunits.php`: flat list replaced with district-centric collapsible sections. 5 batch query methods (districts, centers grouped, classroom counts, active cohort counts per center, center leader names). District sections show collapse arrow, name/code, center + cohort counts, Edit/Add Center/Delete actions. Nested center tables with leader names, classroom counts, cohort counts, status badges. Unassigned centers section. Edit form enhancements: pre-fill type/parent from GET params, dynamic titles ("Add New District"/"Edit Center: X"), contextual breadcrumbs (center → parent district), district edit extras (child centers table + "Add Center" button), center edit extras (linked cohorts, classrooms with child counts, staff/leaders with roles and cohort). Inline CSS + vanilla JS for collapsible toggle with link/button click guard.

### Phase 18: Frontend CSS Design System
- [x] **18.1 CSS Custom Properties & Design System** — Rewrote `assets/css/frontend.css` with `:root` block containing 50+ CSS custom properties (colors, spacing, shadows, radii, transitions, status colors, CRM palette). All existing classes refactored to use `var()` references instead of hardcoded hex values. Added new component classes: `.hl-filters-bar`, `.hl-coach-info-card`, `.hl-coach-widget`, `.hl-session-card`, `.hl-enrollment-switcher`, `.hl-schedule-form`, `.hl-pagination`, `.hl-no-results`, `.hl-btn-danger`, `.hl-input`, `.hl-label`, `.hl-form-group`, `.hl-crm-card-image`, `.hl-crm-card-description`, `.hl-program-card-placeholder`, `.hl-crm-page-header` flex layout.
- [x] **18.2 PHP Inline Style Migration** — Removed all inline styles from 25 frontend shortcode PHP files across 5 batches, replacing with CSS design system classes. Batch 1: my-coaching (coach card, sessions, schedule form), learners (progress bars, filters), cohorts-listing (cards, filters), institutions-listing (sections, counts), pathways-listing (cards, filters). Batch 2: coaching-hub (header, filters), classrooms-listing (filters), reports-hub (descriptions), my-team (subtitles, stats), my-programs (coach widget, image placeholders). Batch 3: program-page (activity action spacing). Batch 4: team-page (metric cards, detail rows), center-page (district link). Batch 5: cohort-workspace (metrics rows, detail rows), my-cohort (detail rows), child-assessment (matrix overflow, form actions), observations (form actions).

### Phase 19: Custom Teacher Self-Assessment System
- [x] **19.1 DB Schema + Domain Model** — New `hl_teacher_assessment_instrument` table (instrument_name, instrument_key, instrument_version, sections JSON, scale_labels JSON, status). Added `responses_json` column to `hl_teacher_assessment_instance` via migration. Schema revision bumped to 6. New `HL_Teacher_Assessment_Instrument` domain model class with `get_sections()` and `get_scale_labels()` JSON decoders.
- [x] **19.2 Teacher Assessment Renderer** — `HL_Teacher_Assessment_Renderer` class supporting PRE mode (single-column likert/scale radios) and POST mode (dual-column retrospective: "Before Program" pre-filled from PRE responses as disabled radios + "Now" column for current ratings). Handles likert sections (5-point and 7-point) and 0-10 numeric scales. Inline CSS for `.hl-tsa-*` classes and JS for draft/submit validation toggle.
- [x] **19.3 Assessment Service Expansion** — Added `get_teacher_instrument()`, `get_teacher_instrument_by_key()`, `get_all_teacher_instruments()`, `save_teacher_assessment_responses()` (draft + submit with responses_json storage), `get_pre_responses_for_post()`, and `update_teacher_assessment_activity_state()` (activity completion + rollup recomputation).
- [x] **19.4 Frontend Shortcode Page** — `HL_Frontend_Teacher_Assessment` handles `[hl_teacher_assessment]` shortcode with instance list view (instrument-based instances per enrollment), single instance form view (delegates to renderer), POST handling for draft/submit, read-only submitted summary, and PRE response pre-fill for POST dual-column mode.
- [x] **19.5 Activity Routing Integration** — Activity page, my-progress, and program page now check `external_ref` for `teacher_instrument_id` before falling through to JFB form rendering. Custom instrument activities create/find instances and redirect to the Teacher Self-Assessment page. Legacy JFB-powered assessments continue to work unchanged.
- [x] **19.6 Admin Instruments Page** — Added "Teacher Assessment Instruments" tab to admin instruments page with full CRUD (list, add, edit, delete). Form has JSON textareas for sections and scale labels definitions.
- [x] **19.7 Bootstrap + Registration** — Registered `[hl_teacher_assessment]` shortcode, added require_once for domain model, renderer, and frontend page. Added "Teacher Self-Assessment" page to create-pages CLI.
- [x] **19.8 Seed Data + B2E Instrument** — Both seed-demo and seed-palm-beach insert the B2E Teacher Self-Assessment instrument (3 sections: Teaching Practices — 12 likert-5 items, Well-being — 6 likert-7 items, Self-Regulation — 10 scale-0-10 items). Activity external_ref updated from JFB form_id to teacher_instrument_id.

### Phase 20: Control Group Support
_For program evaluation research design — comparing program vs control cohort outcomes._

- [x] **20.1 DB Migration + Domain Model** — Added `is_control_group` tinyint(1) column to `hl_cohort` table (migration `migrate_cohort_add_control_group()`, schema revision bumped to 7). Updated `HL_Cohort` domain model with `is_control_group` property and `to_array()`.
- [x] **20.2 Admin Cohort UI** — Save handler includes `is_control_group`. Cohort list shows purple "Control" badge. Editor header shows "Control Group" badge. Details form adds checkbox after Cohort Group dropdown. Tabbed editor auto-hides Coaching and Teams tabs for control group cohorts.
- [x] **20.3 Frontend Cohort Workspace** — Teams tab auto-hidden for control group cohorts (classrooms, staff, dashboard, reports tabs remain).
- [x] **20.4 Reporting Service — Comparison Methods** — `get_group_assessment_comparison($group_id)` aggregates responses_json from teacher assessment instances for program vs control cohorts in a group. Per-section, per-item mean/n/sd for both PRE and POST phases. `export_group_comparison_csv($group_id)` flattens to CSV with per-item means, change values, and Cohen's d effect size. Helper methods: `aggregate_assessment_responses()`, `compute_sd()`, `compute_pooled_sd()`.
- [x] **20.5 Admin Reporting — Comparison UI** — Added Cohort Group dropdown to filters bar. New `render_group_comparison()` section appears when group filter is active and group contains both program + control cohorts. Info cards (program/control cohort names + participant counts), per-section comparison tables with color-coded change values, "Export Comparison CSV" button. `comparison_csv` export handler.
- [x] **20.6 Seed Data — Lutheran Control Cohort** — Palm Beach seeder (`seed-palm-beach`) creates: "B2E Program Evaluation" cohort group (B2E-EVAL), assigns ELC Palm Beach cohort to group, creates "Lutheran Services Florida — Control Group" (LSF-CTRL-2026) as control cohort in same group, assessment-only pathway (PRE + POST self-assessment activities), 6 control participants with submitted PRE assessments, program cohort PRE assessments also seeded for comparison. Clean command removes all control group data.

#### Setting Up a Control Group Cohort
1. **Create a Cohort Group** (Admin → Cohort Groups → Add New) — e.g., "B2E Program Evaluation"
2. **Assign the program cohort** to that group (Cohort → Details → Cohort Group dropdown)
3. **Create a new cohort**, check "Control Group" checkbox, assign to the same group
4. **Create an assessment-only pathway** for the control cohort — just PRE + POST self-assessment activities (using the B2E teacher instrument)
5. **Import or enroll participants** in the control cohort, assign the pathway
6. **Participants fill out assessments** — comparison reports appear in Admin → Reports when selecting the Group filter

### Phase 21: Assessment System Overhaul + Lutheran Seeder + Nuke Command

- [x] **21.1 Nuclear Clean Command** — Created `wp hl-core nuke --confirm="DELETE ALL DATA"`. Dynamically discovers all `hl_*` tables via `SHOW TABLES LIKE`, shows per-table row counts before truncating, removes seeded WP users (protects user ID 1 + current CLI user), resets auto-increment, clears HL Core transients. Safety gate: only runs on staging/local sites.
- [x] **21.2 Teacher Self-Assessment Enhancements** — Fixed renderer Likert values from 1-based to 0-based (0-4 for 5-point, 0-6 for 7-point, 0-10 for numeric). Added per-item left/right anchor support for scale sections. Added `activity_id` URL param support to frontend shortcode (resolves instance from activity context). Added `activity_id` and `started_at` columns to `hl_teacher_assessment_instance`. Updated B2E instrument JSON to match actual assessment documents: 20 Teaching Practices items (5-point Likert), 4 Well-being items with per-item anchors (0-10 scale), 4 Emotion Regulation items (7-point Likert). Shared instrument definitions via static methods on `HL_CLI_Seed_Demo`.
- [x] **21.3 Child Assessment Enhancements** — Added `activity_id`, `phase`, `responses_json`, `started_at` columns to `hl_child_assessment_instance`. Changed `instrument_age_band` from enum to varchar(20) to support 'k2'. Made `classroom_id` nullable. Added `activity_id` URL param support to frontend shortcode. Added `save_child_assessment_responses()` and `get_child_assessment_by_activity()` service methods. Added child assessment question definitions for 4 age bands (infant, toddler, preschool, k2) from assessment documents. Schema revision bumped to 8.
- [x] **21.4 Lutheran Control Group Seeder** — Created `wp hl-core seed-lutheran` (1258-line class): 14-step seeder loading data from `data/extracted_data.php` (extracted from Lutheran Excel files). Creates 1 district, 11 centers, control cohort (LUTHERAN_CONTROL_2026) in B2E Evaluation cohort group, 47 classrooms with age band normalization, 47 WP users, enrollments, teaching assignments, 286 children, assessment-only pathway (4 activities: TSA Pre, CA Pre, TSA Post, CA Post), B2E instrument, child assessment instruments per age band, assessment instances, activity states. POST activities time-gated (fixed_date 2026-05-05). `--clean` flag removes all data in reverse dependency order.
- [x] **21.5 Fix Cohort Group Save Bug** — Proactive `ensure_cohort_group_column()` call at the start of `handle_actions()` (before any INSERT/UPDATE), so the column is guaranteed to exist before the save runs. Self-healing verifies ALTER TABLE succeeded and logs CRITICAL if it didn't. Explicit `$format` array in repository `update()`. Hardened installer migration `migrate_cohort_add_group_id()` with retry logic and post-add verification. Error diagnostics on save failure.
- [x] **21.6 Frontend — Wire Assessment Activities in Program Page** — Program Page batch-loads assessment instance statuses per enrollment. Status-aware button labels: "Start Assessment" / "Continue Assessment" / "View Responses". Teacher self-assessment routes directly to `[hl_teacher_assessment]?activity_id=X` (bypassing Activity Page redirect). Child assessment routes to `[hl_child_assessment]?activity_id=X`. Drip-locked activities show lock icon + amber "Available {date}" badge with no action button. Completed activities show "Completed" badge + "View Responses" link for teacher/child assessments.
- [x] **21.7 Fix Lutheran Seeder Center Matching & Column Indices** — Fixed column index offset bugs: teacher/child rosters have center name at `$row[0]` (not `$row[1]`), child name at `$row[1]` (not `$row[3]`), age group at `$row[3]` (not `$row[4]`). Added `$center_aliases` static map (11 abbreviated roster names → canonical center info names). Added `resolve_center_name()` helper used by seed_classrooms, seed_enrollments, seed_teaching_assignments, and seed_children for consistent classroom key resolution. Added `log_center_resolutions()` to verify alias mappings during seeding. Expanded `normalize_age_band()` with additional child roster variants ("0 -12 months", "2-3 year olds", "1-2  Year olds", "3year old", "1yr-2 1/2"). Moved data from gitignored `data/extracted_data.php` to committed `includes/cli/lutheran-seed-data.php` so data deploys to staging.
- [x] **21.8 Teacher Self-Assessment Pagination** — Added client-side pagination to `HL_Teacher_Assessment_Renderer`: sections display one at a time with step indicator ("Section X of Y" + clickable numbered dots), Previous/Next navigation buttons per section, Save Draft and Submit buttons visible only on last section. All sections remain in one `<form>` so draft/submit works across all sections. Read-only mode (viewing submitted assessments) skips pagination and shows all sections. Inline CSS + JS, no external assets.
- [x] **21.9 Child Assessment Instrument Resolution Fix** — Fixed "No instrument assigned to this assessment" error. Root causes: (1) `resolve_instance_from_activity()` created bare instances without instrument_id, classroom_id, or center_id — added teaching assignment lookup and instrument resolution via `resolve_children_instrument()` fallback chain (exact type → children_mixed → children_preschool → any children_*); (2) `mixed` age band was excluded from instrument matching — removed exclusion; (3) Lutheran seeder didn't create children instruments — added `seed_children_instruments()` creating 4 instruments (infant, toddler, preschool, mixed); (4) `hl_instrument.instrument_type` was enum missing `children_mixed` — changed to varchar(50).
- [x] **21.10 Seeder Children Instance Fix** — Fixed all seeders creating child assessment instances with NULL values for activity_id, phase, and instrument_id. Root cause: `hl_core_teaching_assignment_changed` hook auto-generated bare instances during step 9 (teaching assignments), BEFORE step 12 (instruments) and step 11 (pathway) existed. Then step 13's inserts failed silently on the unique constraint. Fix: all seeders (lutheran, palm-beach, demo) now call `remove_all_actions('hl_core_teaching_assignment_changed')` before creating teaching assignments. Also fixed unique key on `hl_child_assessment_instance` to include `phase` (allows both PRE and POST per enrollment+classroom). Schema revision bumped to 9.
- [x] **21.11 Child Assessment Form Rendering Fix** — Fixed blank form on child assessment page. `render_assessment_form()` was calling `new HL_Instrument_Renderer()` with no constructor arguments, then passing data to `render()` — but the class requires `($instrument, $children, $instance_id, $existing_answers)` in the constructor. Changed to pass arguments to constructor and call `render()` with no args.
- [x] **21.12 Child Assessment Frontend Redesign** — Major redesign of `HL_Instrument_Renderer` and `HL_Frontend_Child_Assessment` to match the original Housman Learning Academy design. Branded header with actual Housman Learning SVG logo (`content_url('/uploads/2024/09/Housman-Learning-Logo-Horizontal-Color.svg')`), teacher/school/classroom info section, instructions panel, age-band-specific Key & Example Behavior table (infant, toddler, preschool/mixed, K-2 from B2E Child Assessment document). Transposed single-question Likert matrix: numeric DB values (0-4) mapped to display labels (Never→Almost Always) via `$likert_labels` array. Fixed nonce mismatch between renderer and POST handler. Removed obsolete `render_inline_matrix()` and `render_field()` fallback methods. Submitted summary view redesigned with same branded layout + answer dot indicators. Responsive design. Polish pass: child rows show full name (first + last) instead of display code, improved text accessibility (darker grays for instructions/DOB/frequency/table headers), question text in dark navy semi-bold instead of italic red, logo 20% smaller, tighter section spacing, submit button visually distinct from draft button.

- [x] **21.13 Teacher Self-Assessment Submit Fix** — Fixed submit button doing nothing after confirm dialog. Root cause: paginated form sections use `display:none` for inactive steps, and `setValidation(true)` added HTML5 `required` attributes to radio inputs in hidden sections — browser native validation silently blocked submission because it can't show tooltips on hidden elements. Fix: replaced native HTML5 validation with custom JS validation that checks all radio groups across all sections, navigates to the first section with missing answers, highlights the unanswered row, and shows a clear error message. Restructured pagination JS to hoist `goToStep()` so the submit handler can call it.

- [x] **21.14 Frontend Polish Batch (6 Fixes)** — All 6 fixes implemented:
  (1) "Back to My Program" links in children + teacher assessment pages — added `find_shortcode_page_url()` + `build_program_back_url()` helpers, links back to program page with `?id=&enrollment=` params, fallback to original behavior if URL can't be built.
  (2) Multi-instance child assessment progress — rewrote `get_assessment_statuses()` to group by `activity_id`, added `partial` status + `children_counts` array, card shows "X/Y Completed" text, progress bar fills proportionally, "Continue Assessment" button.
  (3) Hidden "My Coaching" for control group — added `is_control_group_only()` to BuddyBoss integration, visibility = `$has_enrollment && !$is_control_only`.
  (4) Classroom breadcrumb for control group — added `is_control_group_classroom()` check, shows "Back to My Programs" → `hl_my_programs` page for control group teachers.
  (5) BuddyBoss sidebar spacing — added CSS for `.hl-core-menu-item` + `.hl-buddypanel-section` margin/padding reset and section heading styling.
  (6) Hidden "My Coach" widget for control group in My Programs page; fixed `.hl-btn` base class with `background: var(--hl-surface)`, `color: var(--hl-primary)`, `border-color: var(--hl-border-medium)`.

### Phase 22: Grand Rename — Center→School, Children→Child, Cohort→Track
_See docs/RENAME_PLAN.md for full context and terminology mapping._
_Branch: `feature/grand-rename` — merge only after ALL sub-tasks complete._

**PHASE A: Center → School**

- [x] **A1 — DB Migration** — Schema revision 10: renamed `hl_cohort_center` → `hl_cohort_school`, all `center_id` columns → `school_id` (7 tables), orgunit type 'center'→'school', coach_assignment scope_type 'center'→'school'.
- [x] **A2 — Domain Models & Repositories** — Renamed center_id→school_id in all 5 domain models, 5 repositories. Deprecated `get_centers()` alias kept in OrgUnit repo.
- [x] **A3 — Services Layer** — Renamed in 9 service files: scope, coach-assignment, classroom, team, pathway-assignment, assessment, import (132 occurrences), reporting (51), observation. Zero center refs remaining.
- [x] **A4 — Admin Pages** — Renamed in 12 admin files: orgunits, cohorts, reporting, classrooms, teams, enrollments, imports, coach-assignments, assessments, pathways, admin. UI labels, form fields, nonce actions, tab slugs all updated.
- [x] **A5 — Frontend Shortcodes** — Renamed files (centers-listing→schools-listing, center-page→school-page), classes, shortcodes. Updated 20+ frontend files, hl-core.php, BuddyBoss integration, frontend.css, frontend.js.
- [x] **A6 — CLI & REST API** — Renamed in all 3 seeders (demo, palm-beach, lutheran), create-pages, lutheran-seed-data. Only real place names and Excel column headers preserved.
- [x] **A7 — Documentation** — Updated all 11 docs + CLAUDE.md. ~250 replacements across documentation.

**PHASE B: Child Assessment → Child Assessment**

- [x] **B1 — DB Migration (Opus)** — Schema revision 11: renamed `hl_child_assessment_instance` → `hl_child_assessment_instance`, `hl_child_assessment_childrow` → `hl_child_assessment_childrow`, activity_type enum 'child_assessment'→'child_assessment'. Fixed stale AFTER center_id in old migration.
- [x] **B2 — All PHP Code (Opus)** — Renamed in 19 files: frontend class/file, shortcode [hl_child_assessment], 14 service methods, admin labels, CLI seeders, instrument renderer, CSS classes. Zero hits remaining outside installer migration code.
- [x] **B3 — Documentation (Sonnet)** — Updated all 11 docs + CLAUDE.md + README.md: "Children Assessment" → "Child Assessment", table names, shortcode names. ~80 replacements across documentation.

**PHASE C: Cohort → Track + CohortGroup → Cohort** _(most complex)_

- [x] **C1 — DB Migration (Opus, CRITICAL)** — Schema revision 12: hl_cohort→hl_track (track_id, track_uuid, track_code, track_name), hl_cohort_group→hl_cohort (cohort_id, cohort_uuid, cohort_name, cohort_code), hl_cohort_school→hl_track_school. cohort_id→track_id in 12 dependent tables. cohort_completion_percent→track_completion_percent. All operations idempotent.
- [x] **C2 — Domain Models & Repositories (Opus)** — Rename HL_Cohort→HL_Track (class/file). Rename HL_Cohort_Group→HL_Cohort. Update HL_Enrollment (cohort_id→track_id). Update ALL repositories: HL_Cohort_Repository→HL_Track_Repository, cohort_group repo→HL_Cohort_Repository. Update all SQL.
- [x] **C3 — Services Layer (Opus)** — Rename HL_Cohort_Service→HL_Track_Service. Create NEW HL_Cohort_Service for container entity. Update ALL services: cohort_id→track_id. Update HL_Reporting_Service: group_summary→cohort_summary. Update HL_Scope_Service: cohort_ids→track_ids.
- [x] **C4 — Admin Pages (Opus, parallel with C5/C6)** — Rename admin-cohorts→admin-tracks. Rename admin-cohort-groups→admin-cohorts. Update ALL admin pages: cohort_id→track_id, labels. Menu: "Cohorts"→"Tracks" for runs, "Cohort Groups"→"Cohorts" for containers.
- [x] **C5 — Frontend Shortcodes (Opus, parallel with C4/C6)** — Rename shortcodes: `[hl_cohort_workspace]`→`[hl_track_workspace]`, `[hl_cohorts_listing]`→`[hl_tracks_listing]`, `[hl_my_cohort]`→`[hl_my_track]`. Rename files/classes. Update all labels and URL params. Update BuddyBoss menu. Update CSS.
- [x] **C6 — CLI & REST API (Sonnet, parallel with C4/C5)** — Update all seeders: create Tracks (not Cohorts) for runs, create Cohorts (not Groups) for containers. Update REST endpoints.
- [x] **C7 — Documentation (Sonnet)** — COMPREHENSIVE update of ALL 11 docs + CLAUDE.md + README.md. Rewrite Glossary: Cohort=container, Track=run. Rewrite Domain Model doc. Update all cross-references, relationship diagrams, table names, column names, shortcodes.

**Post-Rename Verification**
- [x] **V1 — Grep verification** — All stale patterns (center_id, children_assessment, cohort_group, hl_cohort_center, hl_cohort_school) → 0 results in includes/ PHP (excl. installer migrations). All `hl_cohort` refs correctly refer to the container entity. See docs/RENAME_VERIFICATION.md for full results.
- [x] **V2 — Staging test** — nuke (36 tables, 1774 rows) → seed-demo (17/17 steps, track_id=1, code=DEMO-2026) → DB verified. See docs/RENAME_VERIFICATION.md.
- [x] **V3 — Lutheran test** — nuke → seed-lutheran (14/14 steps, track_id=1, cohort_id=1, is_control_group=1, 47 teachers, 286 children) → DB verified. See docs/RENAME_VERIFICATION.md.

### Phase 23: Child Assessment Restructure — Per-Child Age Groups + Roster Management
_See docs/CHILD_ASSESSMENT_RESTRUCTURE.md for architecture. Prompts in docs/CHILD_ASSESSMENT_PROMPTS.md._

- [x] **23.1 — DB Migration + Age Group Constants (Opus)** — New `hl_child_track_snapshot` table (child_id, track_id, frozen_age_group, dob_at_freeze, age_months_at_freeze). New `HL_Age_Group_Helper` utility class with system-wide age ranges (infant <12mo, toddler 12-35mo, preschool 36-59mo, k2 60+mo). ALTER `hl_child_classroom_current` add status/removed_by/removal_reason/added_by columns. ALTER `hl_child_assessment_childrow` add status/skip_reason/frozen_age_group/instrument_id columns. Make `hl_child_assessment_instance.instrument_id` nullable.
- [x] **23.2 — Snapshot Service + Freeze Logic (Opus)** — New `HL_Child_Snapshot_Service`: `freeze_age_groups($track_id)` calculates and stores frozen age group for every child based on DOB, `get_frozen_age_group()`, `ensure_snapshot()` for single child. Update `generate_child_assessment_instances()` to call freeze first.
- [x] **23.3 — Classroom Roster Management Service (Opus)** — `teacher_remove_child()` soft-removes with reason/note, writes history. `teacher_add_child()` with duplicate detection on (first_name, last_name, DOB, school_id), auto-creates snapshot. Update `get_children_in_classroom()` to filter by status='active' by default.
- [x] **23.4 — Classroom Page Frontend (Opus)** — Teacher add/remove children on Classroom Page. Add Child form (name, DOB, gender). Remove modal with reason dropdown + note. `?return_to_assessment=ID` param for seamless back-navigation. Access: assigned teachers + staff only.
- [x] **23.5 — Instrument Renderer Rewrite (Opus, LARGEST)** — Rewrite `HL_Instrument_Renderer` to group children by frozen_age_group. Factory method assembles data: gets active children, gets snapshots, groups by age group, loads per-age-group instruments. Each section: header, behavior key, question, Likert matrix. "Missing a child?" link at bottom with AJAX draft auto-save before redirect to Classroom Page.
- [x] **23.6 — Child Assessment Frontend + Reconciliation (Opus)** — Smart roster reconciliation at render time (removed children hidden, new children added with blank answers). Submit-time race condition handling (stale_at_submit, not_yet_assessed). Per-child "No longer in my classroom" checkbox with skip_reason. AJAX draft save endpoint for "Missing a child?" flow. Submitted summary grouped by age group with skip badges.
- [x] **23.7 — Admin Updates (Sonnet)** — Admin Classrooms: collapsible "Removed Children" section with badges. Teacher-added children "Added by {name}" badges. Admin Assessments: childrow status badges (skipped/stale/not_in_classroom), frozen_age_group badges, grouped by age group. CSV export: frozen_age_group, child status, instrument_name columns added.
- [x] **23.8 — Seeders Update (Sonnet)** — All 3 seeders (demo, palm-beach, lutheran) call `freeze_age_groups()` after creating children. Demo data already has mixed age groups (Mixed Age Room classroom). All --clean commands delete from hl_child_track_snapshot.
- [x] **23.9 — Documentation (Sonnet)** — Updated docs 01 (added Frozen Age Group + Child Track Snapshot glossary terms), 02 (added ChildTrackSnapshot entity, updated ChildClassroomAssignment fields), 06 (added per-child age group section, updated instruments/form rendering/admin generation), 10 (updated Classroom Page + Child Assessment UX), CLAUDE.md, README.md Key Design Decisions.
- [x] **23.10 — Staging Deploy + Test (Sonnet)** — Deployed, nuked, seed-demo (26 snapshots: 4 age groups), seed-lutheran (286 snapshots: 4 age groups). Verified in docs/PHASE23_VERIFICATION.md.

### Phase 24: Teacher Assessment — Admin Visual Editor + Frontend Design Upgrade

- [x] **24.1 — DB + Domain Model** — Added `instructions longtext DEFAULT NULL` column to `hl_teacher_assessment_instrument`. Added `$instructions` property, `get_instructions()` method, and `to_array()` update to domain model.
- [x] **24.2 — Admin Visual Section Editor** — Replaced raw JSON textareas with structured visual editor: collapsible section accordion panels (section_key, title, rich text description, type/scale_key dropdowns, items table with add/remove), scale label panels (likert ordered labels with add/remove, or numeric low/high anchors, scale key rename), wp_editor for instructions with minimal B/I/U toolbar. Save handler rebuilds JSON from structured POST fields. New CSS (`admin-teacher-editor.css`) and JS (`admin-teacher-editor.js`) assets conditionally enqueued on instruments page.
- [x] **24.3 — Frontend Header Dedup + Display Options** — Removed duplicate `hl-assessment-meta` div from frontend teacher assessment page. Added 7th `$display_options` constructor param to `HL_Teacher_Assessment_Renderer` (show_instrument_name, show_program_name, program_name). Phase label is now the primary `<h2>` heading. Instrument-level instructions rendered below header when non-empty. Rich text support (`wp_kses_post`) for section descriptions and item text. Submitted summary also cleaned up.
- [x] **24.4 — Frontend Modern Design Overhaul** — Complete CSS rewrite of teacher assessment renderer: card container (max-width 900px, centered, rounded shadow), centered header with program name subtitle, instructions callout box, modern step indicator dots with scale transition, custom radio styling (round fill with inner dot), generous padding/spacing, rounded borders on tables and scale rows, larger action buttons centered with border-top separator, arrow icons on nav buttons, responsive breakpoints.
- [x] **24.5 — Likert Font Size Increase** — Teacher assessment: label columns `0.78em` → `0.92em`, scale labels `0.82em` → `0.95em`. Child assessment: thead `13px` → `15px`.

### Phase 25: Customizable Child Assessment Instructions & Behavior Key

- [x] **25.1 — DB + Admin + Frontend + Seeders** — Added `instructions` (longtext) and `behavior_key` (longtext JSON) columns to `hl_instrument`. Schema revision 13→14. Admin instrument form: wp_editor for custom instructions (minimal B/I/U toolbar, "leave blank for default"), fixed 5-row behavior key table (label, frequency, description inputs with placeholder defaults). Save logic: `wp_kses_post` for instructions, JSON-encoded behavior_key array with all-blank→NULL fallback. Frontend `HL_Instrument_Renderer`: `render_instructions()` checks DB first (multi-age-group uses first non-empty), falls back to hard-coded paragraph. `get_behavior_key_for_age_band()` checks `$instrument->behavior_key` JSON (5-element array), falls back to hard-coded switch. All 3 seeders (demo, lutheran, palm-beach) updated with `HL_CLI_Seed_Demo::get_behavior_key_for_band()` static helper that builds [{label, frequency, description}] from existing B2E assessment data.

### Phase 26: Assessment CSV Export — Response Data Exports

- [x] **26.1 — Teacher Responses CSV** — New `export_teacher_assessment_responses_csv($track_id)` method reads `responses_json` from instances, loads instrument sections to build flat column headers (section_title: item_key, e.g. "Instructional Practices: P1"). One row per instance with Name, Email, Phase, Status, Submitted At + item values. Skips `not_started` instances with no data.
- [x] **26.2 — Child Responses CSV** — New `export_child_assessment_responses_csv($track_id)` method. One row per child per instance with Teacher Name, Email, Classroom, School, Phase, Status, Submitted At, Child Name, DOB, Frozen Age Group, Instrument + answer columns. Excludes skipped children. Fixed instrument `name` column bug.
- [x] **26.3 — Bug Fix** — Fixed `title` → `name` column reference in existing `export_child_assessments_csv()` instrument lookup query (hl_instrument table uses `name`, not `title`).
- [x] **26.4 — Admin UI** — Added dual export buttons ("Export Completion CSV" + "Export Responses CSV") to both Teacher and Children tabs. Two new handler cases (`teacher_responses`, `children_responses`) in `handle_csv_export()` with matching nonces.

### Phase 27: Separate PRE/POST Teacher Assessment Instruments

- [x] **27.1 — Split Instrument Definitions** — Renamed `get_b2e_instrument_sections()` → `_pre()` / `_post()` with shared helpers for Assessment 2 (wellbeing) and Assessment 3 (self-regulation). PRE instrument: 20 items in Section 1 ("Assessment 1"), single-column. POST instrument: 15 items in Section 1 with `retrospective: true` flag for dual-column. Section titles simplified from "Assessment 1/3" → "Assessment 1". Added `get_b2e_instrument_instructions_pre()` / `_post()` static helpers. Old `get_b2e_instrument_sections()` retained as deprecated alias.
- [x] **27.2 — Seeder Updates** — All 3 seeders (demo, Lutheran, Palm Beach) now create TWO teacher instruments (`b2e_self_assessment_pre` + `b2e_self_assessment_post`) with distinct sections, instructions, and instrument keys. Activity `external_ref` and assessment instance `instrument_id` correctly reference the PRE or POST instrument. Clean methods updated to delete all three key variants.
- [x] **27.3 — Renderer: Retrospective Flag** — `render_likert_section()` and `render_scale_section()` now gate dual-column on section-level `retrospective` flag instead of `$this->phase === 'post'`. Sections 2+3 in POST always render single-column (matching Housman's design). Column headers updated: "Before Program"→"Prior Assessment Cycle", "Now"→"Past Two Weeks". Removed hard-coded POST instruction paragraph (instrument-level instructions now handle this).
- [x] **27.4 — Staging Deploy + Verify** — Nuke + seed-lutheran: 2 instrument rows (PRE id=1, POST id=2), 47 PRE instances → instrument 1, 47 POST instances → instrument 2, activity external_ref correctly mapped. POST Section 1: 15 items + retrospective=true. PRE Section 1: 20 items, no retrospective.

### Phase 28: Dashboard Shortcode (`[hl_dashboard]`)

- [x] **28.1 — Role-Aware Dashboard** — Created `class-hl-frontend-dashboard.php` with `[hl_dashboard]` shortcode. Role detection via `HL_Scope_Service` + enrollment queries + `hl_track.is_control_group` flag. Welcome banner with time-based greeting and avatar. Participant section: My Programs + My Classrooms for all enrolled; My Coaching for program tracks (hidden for control-group-only users); My Team + Coaching Hub for mentors; My Track for leaders. Staff/admin Administration section with 6 management cards. Cards silently hide if target page doesn't exist. Registered in shortcodes, added to create-pages (25 pages), CSS styles in frontend.css (dark gradient welcome, responsive card grid, hover effects).

### Phase 29: Protect Instruments from Nuke + Admin-Customizable Display Styles

- [x] **29.1 — Nuke Instrument Protection** — Modified `class-hl-cli-nuke.php`: `hl_instrument` and `hl_teacher_assessment_instrument` tables are SKIPPED by default during nuke. Added `--include-instruments` flag to opt-in to instrument truncation. Output shows "SKIPPED (N rows preserved)" for protected tables.
- [x] **29.2 — Seeder Skip-If-Exists** — All 3 seeders (demo, Lutheran, Palm Beach) now check-before-insert for both child instruments (by `name`) and teacher instruments (by `instrument_key`). Existing instruments are reused with their IDs; only missing instruments are created. This means nuke+reseed cycles preserve admin customizations while recreating enrollments/instances pointing to the same instrument IDs.
- [x] **29.3 — Schema: styles_json Column** — Added `styles_json LONGTEXT NULL` to both `hl_instrument` and `hl_teacher_assessment_instrument` CREATE TABLE definitions. Schema revision 14→15. Stores admin-customizable display styles as JSON (font sizes, colors).
- [x] **29.4 — Admin Display Styles Panel** — Added collapsible "Display Styles" section to both child and teacher instrument edit forms in `class-hl-admin-instruments.php`. Per-element rows with font-size dropdown (12-24px + Default) and color picker with "Default" checkbox. Child form: Instructions, Behavior Key, Questions/Items, Scale Labels. Teacher form: Instructions, Section Titles, Section Descriptions, Items, Scale Labels. Save handler builds `styles_json` from POST fields.
- [x] **29.5 — Renderer Style Overrides** — Both `HL_Teacher_Assessment_Renderer` and `HL_Instrument_Renderer` read `styles_json` from their instrument and emit CSS override rules (`!important`) at the end of their `<style>` blocks. Missing/empty keys fall back to built-in defaults.

### Phase 30: Admin Documentation System

- [x] **30.1 — CPT + Taxonomy + Shortcodes** — Created `class-hl-frontend-docs.php` with `hl_doc` CPT (public=false, show_ui=true under HL Core menu) and `hl_doc_category` hierarchical taxonomy. Two shortcodes: `[hl_docs]` (full documentation browser with landing/category/article/glossary views) and `[hl_doc_link slug="..." text="..."]` (inline cross-reference links). URL routing via `?doc=slug` and `?cat=slug` query parameters. Article pages include auto-generated TOC, sidebar navigation, prev/next navigation. Glossary page with alphabetized letter nav and definition list. Graceful degradation for missing article slugs.
- [x] **30.2 — CSS + JS** — Created `frontend-docs.css` (~400 lines) using HL Core design system tokens. Responsive layout with 2-column sidebar+main for articles, category card grid for landing, mobile slide-out sidebar with FAB toggle. Created `frontend-docs.js` (~200 lines) with vanilla JS: TOC generation from h2/h3, scroll spy, sidebar accordion, landing page search filtering from JSON data, sidebar article search, mobile sidebar toggle with overlay.
- [x] **30.3 — Plugin Integration** — Wired into `hl-core.php` (require_once + init), `class-hl-shortcodes.php` (register + has_shortcode + render method), `class-hl-cli-create-pages.php` (Documentation page entry), `class-hl-admin.php` (Documentation external link in submenu), `class-hl-buddyboss-integration.php` (Documentation sidebar item for staff + enrolled users).
- [x] **30.4 — Seed Command** — Created `class-hl-cli-seed-docs.php` with `wp hl-core seed-docs [--clean]`. Seeds 7 categories + ~22 articles (3 Getting Started, 5 Core Concepts, 4 Assessments, 3 Coaching & Observations, 2 Import & Data Management, 3 Pathways & Activities, 2 Reports & Exports) + ~15 glossary terms. All articles contain real, useful content with `[hl_doc_link]` cross-references. Skip-if-exists by slug. `--clean` flag deletes all hl_doc posts before seeding.

### Phase 31: K-2nd Grade Age Group + JFB Cleanup + Instrument Preview

- [x] **31.1 — K-2nd Grade instrument type** — Added `children_k2` instrument type across the entire plugin: admin instrument valid types, dropdown, labels, SQL queries (now use `LIKE 'children_%'`); classroom age_band dropdown; CSV import validation; DB schema migration (rev 16) to add 'k2' to `hl_classroom.age_band` ENUM. All 3 seeders (Lutheran, Palm Beach, Demo) now create K-2 instruments with the correct B2E question from the source document. Demo and Palm Beach seeders upgraded from generic placeholder questions to real B2E per-age-band questions. Lutheran `normalize_age_band()` extended with K-2 patterns.
- [x] **31.2 — JFB reference cleanup** — Removed all JetFormBuilder labels from admin UI. Pathways: activity type labels no longer say "(JFB)"; teacher self-assessment is no longer disabled when JFB is inactive (only observation requires JFB); JFB form dropdown hidden for teacher self-assessment activities; JS field toggler updated; `build_external_ref` for teacher assessments saves only phase (no JFB form_id); `format_external_ref` shows phase label for teacher assessments. Assessments: removed legacy JFB fallback message.
- [x] **31.3 — Instrument preview** — Added Preview action for both child and teacher instruments. Preview renders the saved instrument using the frontend renderer in read-only mode. Child preview uses 5 sample children with sample teacher/school context and `pointer-events: none`. Teacher preview uses `read_only` mode with Pre/Post phase toggle (POST shows dual-column retrospective with sample "Before" ratings). Preview buttons in listing tables (Edit | Preview | Delete) and edit forms.
- [x] **31.4 — Documentation update** — Docs seeder updated to reference all 4 age groups (Infant, Toddler, Preschool/Pre-K, K-2nd Grade) in child assessment, instruments, and classrooms articles.
- [x] **31.5 — Bug fixes** — Fixed instrument color styles not saving (Default checkbox auto-uncheck on color pick). Fixed child instrument edit form failing for children_mixed type (missing from valid_types, dropdown, labels).

### Lower Priority (Future)
- [x] **ANY_OF and N_OF_M prerequisite types** — Rules engine `check_prerequisites()` rewritten to evaluate all_of, any_of, and n_of_m group types. Admin UI prereq group editor with type selector and activity multi-select. Seed demo includes examples of all three types. Frontend lock messages show type-specific wording with blocker activity names.
- [x] **Grace unlock override type** — `compute_availability()` now recognizes `grace_unlock` override type: bypasses prerequisite gate but NOT drip rules (mirrors `manual_unlock` which bypasses drip but NOT prereqs).
- [x] **Prerequisite cycle detection on save** — `validate_no_cycles()` builds dependency adjacency list scoped to pathway, runs iterative DFS with 3-color marking. Admin `save_activity()` validates before persisting prereqs; cycle detected → transient error message → redirect back with descriptive cycle path.
- [ ] Scope-based user creation for client leaders
- [ ] Import templates (downloadable CSV)

---

## Architecture

```
/hl-core/
  hl-core.php                    # Plugin bootstrap (singleton)
  /includes/
    class-hl-installer.php       # DB schema + activation
    /domain/                     # Entity models (9 classes)
    /domain/repositories/        # CRUD repositories (8 classes)
    /cli/                        # WP-CLI commands (seed-demo, seed-lutheran, seed-palm-beach, nuke, create-pages, seed-docs) — 6 commands + lutheran-seed-data.php
    /services/                   # Business logic (14+ services incl. HL_Scope_Service, HL_Pathway_Assignment_Service)
    /security/                   # Capabilities + authorization
    /integrations/               # LearnDash + JetFormBuilder + BuddyBoss (3 classes)
    /admin/                      # WP admin pages (15+ controllers incl. Cohorts, Tracks)
    /frontend/                   # Shortcode renderers (28 pages incl. dashboard + documentation + instrument renderer + teacher assessment renderer)
    /api/                        # REST API routes
    /utils/                      # DB, date, normalization helpers
  /data/                         # Private data files (gitignored)
  /assets/
    /css/                        # admin.css, admin-import-wizard.css, admin-teacher-editor.css, frontend.css, frontend-docs.css
    /js/                         # admin-import-wizard.js, admin-teacher-editor.js, frontend.js, frontend-docs.js
  /docs/                         # AI library (11 spec documents)
```

## Key Design Decisions
- **Custom-first assessment architecture:** Teacher Self-Assessments use a custom PHP instrument system (structured JSON definitions in `hl_teacher_assessment_instrument`, responses in `hl_teacher_assessment_instance.responses_json`) because the POST version requires a dual-column retrospective format and structured data is needed for research comparison. Child Assessments use custom PHP (dynamic per-child matrix from classroom roster). Observations are the only remaining JFB-powered form type (admins need to customize observation questions without a developer). Coaching Sessions are custom PHP admin CRUD. Legacy JFB teacher assessment support retained for backward compatibility. See CLAUDE.md and doc 06 for details.
- Track roles stored on Enrollment, NOT WP user roles
- Custom database tables for all core domain data (no post_meta abuse)
- Teacher self-assessment responses stored in `hl_teacher_assessment_instance.responses_json` (custom system); observation form responses stored in JFB Form Records; HL Core tracks completion status, instance metadata, and structured response data for research comparison
- Child assessment responses stored in `hl_child_assessment_childrow` (custom table) with per-child frozen_age_group, instrument_id, and status columns. Form dynamically generated from classroom roster.
- **Frozen age groups (hl_child_track_snapshot):** Each child's age group is calculated from DOB and frozen per-track at the time children are associated with a track. This ensures PRE and POST assessments use the same instrument/question per child for research consistency. Mixed-age classrooms render multiple age-group sections in a single form. `HL_Child_Snapshot_Service` manages freeze logic. `HL_Age_Group_Helper` provides age-range definitions (infant <12mo, toddler 12-35mo, preschool 36-59mo, k2 60+mo).
- Enrollments are unique per (track_id, user_id)
- Children identity uses fingerprint hashing for import matching
- Rules engine evaluates prerequisites + drip independently per enrollment
- Child classroom assignments maintain current + history tables for audit trail
- Import wizard uses preview/commit pattern with row-level selection
- **Control group research design:** `is_control_group` flag on `hl_track` drives UI adaptations (hidden coaching/teams tabs) and enables program-vs-control comparison reporting at the Cohort level. Cohen's d effect size for measuring program effectiveness. Comparison uses `responses_json` from `hl_teacher_assessment_instance`.

## Plugin Dependencies
- **WordPress 6.0+**
- **PHP 7.4+**
- **JetFormBuilder** (required for observation forms only; teacher assessments use custom PHP instrument system)
- **LearnDash** (required for course progress tracking)
- **BuddyBoss** (optional, for profile navigation integration)

## Activation
1. Ensure JetFormBuilder and LearnDash are installed and active
2. Go to WordPress Admin > Plugins
3. Activate "Housman Learning Core"
4. Tables are created automatically via `dbDelta()`
5. Coach role and capabilities are added
6. Navigate to **HL Core** menu in the admin sidebar
